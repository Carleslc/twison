window.storyFormat({
  "name": "Twison",
  "version": "0.0.2",
  "author": "Mike Lazer-Walker and Carlos LÃ¡zaro Costa",
  "description": "Export your Twine 2 story as a JSON document",
  "proofing": false,
  "source": "<html>\r\n\t<head>\r\n\t\t<title>{{STORY_NAME}}</title>\r\n\t\t<script type=\"text/javascript\">\r\n\t\t/**\r\n\t\t * Twison - Twine 2 JSON Export Story Format\r\n\t\t * \r\n\t\t * Copyright (c) 2015 Mike Walker\r\n\t\t * https://lazerwalker.com\r\n\t\t *\r\n\t\t * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and\r\n\t\t * associated documentation files (the \"Software\"), to deal in the Software without restriction,\r\n\t\t * including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,\r\n\t\t * and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,\r\n\t\t * subject to the following conditions:\r\n\t\t *\r\n\t\t * The above copyright notice and this permission notice shall be included in all copies or substantial\r\n\t\t * portions of the Software.\r\n\t\t *\r\n\t\t * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT\r\n\t\t * LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\r\n\t\t * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\r\n\t\t * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\r\n\t\t * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n\t\t */\r\n\t\tvar Twison={extractLinksFromText:function(t){var e=t.match(/\\[\\[.+?\\]\\]( *{{ *([\\d]+) *}})*/g);if(e){var e=e.map(function(e){var n=e.match(/\\[\\[(.*?)(\\||\\-\\&gt;|\\&lt;\\-)(.*?)\\]\\](?: *{{ *([\\d]+) *}})*/);return t=t.replace(e,\"\"),n?(passageName=n[1],passageLink=n[3],\"&lt;-\"===n[2]&&(passageLink=n[1],passageName=n[3]),{name:passageName,link:passageLink,timeout:n[4]}):(e=e.substring(2,e.length-2),{name:e,link:e})});return{links:e,text:t}}},extractStatementsFromText:function(t){for(var e,n,a=/\\((if): *([^)]*)\\) *\\[(\\([^)]*\\))\\](?:\\n\\((else):\\) *\\[(\\([^)]*\\))\\]){0,1}/gm,s=[],r=t,o=null;e=a.exec(t);)n={conditions:function(t){var e=[];return t.split(\"and\").forEach(function(t){var n=t.trim().split(\" \");e.push({variable:n[0],operator:n[1],operand:n[2]})}),e}(e[2]),actions:Twison.extractActions(e[3]).actions},e[5]&&(o={actions:Twison.extractActions(e[5]).actions}),s.push({if:n,else:o}),r=r.replace(e[0],\"\");return{text:r,statements:s}},extractActions:function(t,e){for(var n,a,s,r,o=/\\(([^ :]+) *\\: *([^)]*)\\)/g,i=/([^ ]+) *(to) *([^\\n]*)/,c=[],l=t;n=o.exec(t);)a={name:n[1]},\"set\"===n[1]?(s=[],r=n[2].split(\",\"),a.values=[],r.forEach(function(t){var e=t.trim();e.length&&s.push(e)}),s.forEach(function(t){var e=t.match(i);e?a.values.push({variable:e[1],operator:e[2],operands:e[3].split(\" \")}):console.error(\"err\",t)})):\"go-to\"===n[1]&&(a.value=n[2].replace(/\\\"/g,\"\")),c.push(a),e&&(l=l.replace(n[0],\"\"));return{actions:c,text:l}},convertPassage:function(t){var e={text:t.innerHTML},n=Twison.extractLinksFromText(e.text);if(n&&(e.links=n.links,e.text=n.text),n=Twison.extractStatementsFromText(e.text),n&&(e.text=n.text,e.statements=n.statements),n=Twison.extractActions(e.text,!0),n&&(e.text=n.text,e.actions=n.actions),e.text=e.text.replace(/\\n\\s*\\n/g,\"\\n\"),[\"name\",\"pid\",\"tags\"].forEach(function(n){var a=t.attributes[n].value;a&&(e[n]=a)}),e.position){var a=e.position.split(\",\");e.position={x:a[0],y:a[1]}}return e.tags&&(e.tags=e.tags.split(\" \")),e},convertStory:function(t){var e=t.getElementsByTagName(\"tw-passagedata\"),n=Array.prototype.slice.call(e).map(Twison.convertPassage),a={passages:n};[\"name\",\"startnode\",\"creator\",\"creator-version\",\"ifid\"].forEach(function(e){var n=t.attributes[e].value;n&&(a[e]=n)});var s={};return a.passages.forEach(function(t){s[t.name]=t.pid}),a.passages.forEach(function(t){t.links&&t.links.forEach(function(t){t.pid=s[t.link],t.pid||(t.broken=!0)})}),a},convert:function(){var t=document.getElementsByTagName(\"tw-storydata\")[0],e=JSON.stringify(Twison.convertStory(t),null,2);document.getElementById(\"output\").innerHTML=e}};window.Twison=Twison;\t\t\r\n\t\t</script>\r\n\t</head>\r\n\t<body>\r\n\t\t<pre id=\"output\">\r\n\t\t</pre>\r\n\t\t<div id=\"storyData\" style=\"display: none;\">\r\n\t\t\t{{STORY_DATA}}\r\n\t\t</div>\r\n\t\t<script>\r\n\t\t\tTwison.convert()\r\n\t\t</script>\r\n\t</body>\r\n</html>"
});